import { useEffect, useMemo, useState } from "react";
import { createRoot } from "react-dom/client";
import "../../index.css";
import { useStore } from "../../store/useStore";
import {
  aggregateWeeklyData,
  getTopDomains,
  getTotalSeconds,
  getUniqueDomainsCount,
  IGNORED_DOMAINS,
} from "../../utils/data";
import { exportToCSV } from "../../utils/export";
import { Header } from "./components/Header";
import { StatsOverview } from "./components/StatsOverview";
import { ActivityCharts } from "./components/ActivityCharts";
import { UsageDetails } from "./components/UsageDetails";
import { CommonLoader } from "../../common/common-loader";
import { ThemeProvider } from "../../components/theme-provider";
import { useUsageColumns } from "./columns";
import { ErrorBoundary } from "../../components/ErrorBoundary";
import { ProductivityScore } from "../../components/ProductivityScore";

const CATEGORY_COLORS: Record<string, string> = {
  Work: "#3b82f6",
  Learning: "#10b981",
  Social: "#a855f7",
  Other: "#64748b",
};

// Helper functions to get Monday and Sunday of a week
const getMondayOfWeek = (date: Date): Date => {
  const d = new Date(date);
  const day = d.getDay();
  const diff = d.getDate() - day + (day === 0 ? -6 : 1); // Adjust when day is Sunday
  d.setDate(diff);
  return d;
};

const getSundayOfWeek = (date: Date): Date => {
  const monday = getMondayOfWeek(date);
  const sunday = new Date(monday);
  sunday.setDate(monday.getDate() + 6);
  return sunday;
};

const Dashboard = () => {
  const { usage, categories, isLoading, fetchData, updateCategory, resetData } =
    useStore();

  // Separate state for bar chart (date range) and pie chart (single date)
  const [startDate, setStartDate] = useState(() => getMondayOfWeek(new Date()));
  const [endDate, setEndDate] = useState(() => getSundayOfWeek(new Date()));
  const [pieChartDate, setPieChartDate] = useState(new Date());
  const [tableDate, setTableDate] = useState(new Date());
  const [dateSyncEnabled, setDateSyncEnabled] = useState(true);

  const [searchTerm, setSearchTerm] = useState("");

  const startDateStr = startDate.toISOString().split("T")[0];
  const endDateStr = endDate.toISOString().split("T")[0];
  const pieChartDateStr = pieChartDate.toISOString().split("T")[0];
  const tableDateStr = tableDate.toISOString().split("T")[0];

  useEffect(() => {
    fetchData();
  }, [fetchData]);
  const weeklyData = useMemo(
    () => aggregateWeeklyData(usage, startDateStr, endDateStr),
    [usage, startDateStr, endDateStr]
  );
  const todayTopDomains = useMemo(
    () => getTopDomains(usage, tableDateStr, 50),
    [usage, tableDateStr]
  );

  const filteredDomains = useMemo(() => {
    return todayTopDomains.filter((d) =>
      d.domain.toLowerCase().includes(searchTerm.toLowerCase())
    );
  }, [todayTopDomains, searchTerm]);

  const totalTodaySeconds = useMemo(
    () => getTotalSeconds(usage, pieChartDateStr),
    [usage, pieChartDateStr]
  );

  const categoryData = useMemo(() => {
    const dayUsage = usage[pieChartDateStr] || {};
    const summary = Object.entries(dayUsage)
      .filter(([domain]) => !IGNORED_DOMAINS.includes(domain))
      .reduce((acc, [domain, seconds]) => {
        const cat = categories[domain] || "Other";
        acc[cat] = (acc[cat] || 0) + seconds;
        return acc;
      }, {} as Record<string, number>);

    return Object.entries(summary).map(([name, value]) => ({
      name,
      value: Math.round((value / 3600) * 100) / 100, // Convert to hours with 2 decimal places
    }));
  }, [usage, pieChartDateStr, categories]);

  const usageColumns = useUsageColumns({ categories, updateCategory });

  // Date sync effect
  useEffect(() => {
    if (dateSyncEnabled) {
      setTableDate(pieChartDate);
      setStartDate(getMondayOfWeek(pieChartDate));
      setEndDate(getSundayOfWeek(pieChartDate));
    }
  }, [pieChartDate, dateSyncEnabled]);

  const handlePreviousWeek = () => {
    const newDate = new Date(startDate);
    newDate.setDate(newDate.getDate() - 7);
    setStartDate(getMondayOfWeek(newDate));
    setEndDate(getSundayOfWeek(newDate));
    if (dateSyncEnabled) {
      const monday = getMondayOfWeek(newDate);
      setPieChartDate(monday);
      setTableDate(monday);
    }
  };

  const handleNextWeek = () => {
    const newDate = new Date(startDate);
    newDate.setDate(newDate.getDate() + 7);
    setStartDate(getMondayOfWeek(newDate));
    setEndDate(getSundayOfWeek(newDate));
    if (dateSyncEnabled) {
      const monday = getMondayOfWeek(newDate);
      setPieChartDate(monday);
      setTableDate(monday);
    }
  };

  const setAllDatesToToday = () => {
    const today = new Date();
    setPieChartDate(today);
    setTableDate(today);
    setStartDate(getMondayOfWeek(today));
    setEndDate(getSundayOfWeek(today));
  };

  // Keyboard shortcuts
  useEffect(() => {
    const handleKeyPress = (e: KeyboardEvent) => {
      // Ctrl/Cmd + Left Arrow: Previous week
      if ((e.ctrlKey || e.metaKey) && e.key === "ArrowLeft") {
        e.preventDefault();
        handlePreviousWeek();
      }
      // Ctrl/Cmd + Right Arrow: Next week
      if ((e.ctrlKey || e.metaKey) && e.key === "ArrowRight") {
        e.preventDefault();
        handleNextWeek();
      }
      // Ctrl/Cmd + T: Jump to today
      if ((e.ctrlKey || e.metaKey) && e.key === "t") {
        e.preventDefault();
        setAllDatesToToday();
      }
    };

    window.addEventListener("keydown", handleKeyPress);
    return () => window.removeEventListener("keydown", handleKeyPress);
  }, [startDate, endDate, dateSyncEnabled]);

  if (isLoading) {
    return <CommonLoader message="Analyzing your productivity..." />;
  }

  return (
    <div className="min-h-screen bg-background text-foreground font-sans p-6 lg:p-10 transition-colors duration-300">
      <div className="max-w-7xl mx-auto space-y-10">
        <Header
          onExport={() => exportToCSV(usage, categories)}
          onReset={resetData}
        />

        )}

          className="flex items-center justify-end gap-2 -mt-4 mb-2"
          data-onboarding="date-sync"
        >
          <label className="flex items-center gap-2 text-sm text-muted-foreground cursor-pointer hover:text-foreground transition-colors">
            <input
              type="checkbox"
              checked={dateSyncEnabled}
              onChange={(e) => setDateSyncEnabled(e.target.checked)}
              className="cursor-pointer"
            />
            Sync all dates
          </label>
          <span className="text-xs text-muted-foreground">
            | Shortcuts: ⌘←/→ (week), ⌘T (today)
          </span>
        </div>

        <ErrorBoundary>
          <StatsOverview
            totalTodaySeconds={totalTodaySeconds}
            uniqueDomainsCount={getUniqueDomainsCount(usage, pieChartDateStr)}
            topCategory={
              categoryData.length > 0
                ? [...categoryData].sort((a, b) => b.value - a.value)[0].name
                : "--"
            }
          />
        </ErrorBoundary>

        <ErrorBoundary>
          <ProductivityScore
            usage={usage}
            categories={categories}
            dateRange={{ start: startDateStr, end: endDateStr }}
          />
        </ErrorBoundary>

        <ErrorBoundary>
          <ActivityCharts
            weeklyData={weeklyData}
            categoryData={categoryData}
            categoryColors={CATEGORY_COLORS as any}
            startDate={startDate}
            endDate={endDate}
            onPreviousWeek={handlePreviousWeek}
            onNextWeek={handleNextWeek}
            selectedDate={pieChartDate}
            onDateChange={setPieChartDate}
          />
        </ErrorBoundary>

        <ErrorBoundary>
          <UsageDetails
            today={tableDateStr}
            searchTerm={searchTerm}
            onSearchChange={setSearchTerm}
            filteredDomains={filteredDomains}
            columns={usageColumns}
            selectedDate={tableDate}
            onDateChange={setTableDate}
          />
        </ErrorBoundary>
      </div>
    </div>
  );
};

const container = document.getElementById("root");
if (container) {
  const root = createRoot(container);
  root.render(
    <ThemeProvider defaultTheme="dark" storageKey="aegis-theme">
      <Dashboard />
    </ThemeProvider>
  );
}
